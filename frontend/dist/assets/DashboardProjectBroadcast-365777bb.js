import{$ as E,d as W,i as _,j as e,F as m,I as H,m as te,R as j,aq as $,ar as re,aa as A,as as ce,a as C,E as R,w as q,A as I,u as oe,z as le,b as ne,e as de,l as ie,o as ue,N as me,ah as he,M as F,an as pe,am as fe}from"./index-9951c21b.js";import{S as je,P as xe,G as be}from"./ProjectLayout-f8ff0662.js";import{C as ve}from"./ChatMessageItemCard-f040a5ec.js";import{C as _e,a as ge,L as Ne,P as Se,b as we,p as De,c as ye,d as Ce,e as ke}from"./index-23283699.js";class k{static async fetchCreateProjectWorkDevice(t){return E.post("/projects/device/",t)}static async fetchUpdateProjectWorkDevice(t,l){return E.patch(`/projects/device/${t}/`,l)}static async fetchDeleteProjectWorkDevice(t){return E.delete(`/projects/device/${t}/`)}static async fetchDetailProjectWorkDevice(t){return E.get(`/projects/device/${t}/`)}static async fetchGetDeviceStreamData(t,l){return E.get(`/projects/device/${t}/stream/`,{params:l})}static async fetchGetDeviceStreamDataLast(t,l){return E.get(`/projects/device/${t}/stream/`,{params:{...l,page_size:1}})}}const Me=({ws:d,messages:t})=>{const{user:l}=W(i=>i.auth);_.useState({post:!1});const[o,x]=_.useState(!1),[p,g]=_.useState("");_.useState({});const c=i=>{g(i.target.value)},b=i=>{i.preventDefault(),d.send(JSON.stringify({type:"send_command",data:{command:p,to:"device"}})),g("")};return _.useEffect(()=>{d&&d.readyState===1?x(!0):x(!1)},[d==null?void 0:d.readyState]),e.jsxs("div",{className:"card w-100",children:[e.jsx("div",{className:"card-header",children:e.jsx(m,{id:"send",defaultMessage:"Send"})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{children:e.jsx("form",{className:"form-group px-3",onSubmit:b,children:e.jsxs("div",{className:"input-group mb-3",children:[e.jsx("input",{type:"text",name:"command",value:p,className:"form-control",autoComplete:"off",onChange:c,disabled:!o}),e.jsx("div",{className:"input-group-append",children:e.jsx("button",{type:"submit",className:"btn btn-send-message",children:e.jsx(H,{path:te,size:1})})})]})})}),e.jsx("div",{className:"px-1",children:t.map((i,S)=>e.jsx(ve,{active_me:l.id===i.author.user_id,message:i},S))})]})})]})},Ee=({onSuccess:d,projectWork:t,device:l})=>{const[o,x]=_.useState({script_id:0,password:"",title:"",sensor_data_labels:[{field:"temp",label:"Tempreature"}]}),[p,g]=j.useState({}),[c,b]=j.useState({detail:!1,post:!1}),i=r=>{x(a=>({...a,[r.target.name]:r.target.value}))},S=(r,a)=>{const u=[...o.sensor_data_labels];u[r][a.target.name]=a.target.value,x(f=>({...f,sensor_data_labels:u}))},w=()=>{x(r=>({...r,sensor_data_labels:[...r.sensor_data_labels,{field:"",label:""}]}))},M=r=>{const a=[...o.sensor_data_labels];a.splice(r,1),x(u=>({...u,sensor_data_labels:a}))},D=r=>{r.preventDefault();const a={title:o.title,script_id:o.script_id,password:o.password,sensor_data_labels:o.sensor_data_labels,practical_work_id:t.id};(async()=>{b(f=>({...f,post:!0}));try{if(l){const f=await k.fetchUpdateProjectWorkDevice(l.id,a);d(f.data)}else{const f=await k.fetchCreateProjectWorkDevice(a);d(f.data)}}catch(f){f instanceof I&&f.response?f.response.status==400&&g(f.response.data):console.error(f)}b(f=>({...f,post:!1}))})()},N=j.useMemo(()=>t.files.filter(r=>r.extension===".cpp"),[t.files]);return j.useEffect(()=>{l&&x(r=>({...r,script_id:l.script.id,title:l.title,password:l.password||"",sensor_data_labels:l.sensor_data_labels}))},[l]),e.jsxs("form",{onSubmit:D,children:[e.jsxs("div",{className:"row mb-2",children:[e.jsxs("div",{className:"col-6 form-group mb-2",children:[e.jsx($,{htmlFor:"title",value:"Title"}),e.jsx(re,{id:"title",type:"text",name:"title",value:o.title,className:"form-control",autoComplete:"off",isFocused:!0,onChange:i}),e.jsx(A,{message:p.title,className:"mt-2"})]}),e.jsxs("div",{className:"col-6 form-group mb-2",children:[e.jsx($,{htmlFor:"password",value:"Password"}),e.jsx(ce,{id:"password",name:"password",value:o.password,onChange:i,autoComplete:"off"}),e.jsx(A,{message:p.password,className:"mt-2"})]})]}),e.jsx("div",{className:"row mb-2",children:e.jsxs("div",{className:"col-6 form-group mb-2",children:[e.jsx($,{htmlFor:"password",value:e.jsx(m,{id:"script",defaultMessage:"Script"})}),e.jsxs(C.Select,{name:"script_id",value:o.script_id,onChange:i,children:[e.jsx("option",{value:0,children:"---"}),N.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),e.jsx(A,{message:p.script_id,className:"mt-2"})]})}),l?e.jsx(q,{variant:"warning",children:e.jsx(m,{id:"dashboard.projects_waruu2",defaultMessage:"To modify labels you should recreate new device"})}):e.jsxs("div",{children:[e.jsx(je,{className:"btn-success mb-3",onClick:w,children:e.jsx(m,{id:"dashboard.projects_ad28992",defaultMessage:"Add Variable"})}),e.jsx("div",{className:"row mb-4",children:o.sensor_data_labels.map((r,a)=>e.jsxs("div",{className:"col-6",children:[e.jsxs(C.Group,{className:"mb-3",children:[e.jsx(C.Label,{htmlFor:`input-${a}-field`,children:e.jsx(m,{id:"dashboard.projects_ui328992",defaultMessage:"Field name"})}),e.jsx(C.Control,{id:`input-${a}-field`,name:"field",value:r.field,onChange:u=>S(a,u)})]}),e.jsxs(C.Group,{className:"mb-3",children:[e.jsx(C.Label,{htmlFor:`input-${a}-label`,children:e.jsx(m,{id:"label",defaultMessage:"Label"})}),e.jsx(C.Control,{id:`input-${a}-label`,name:"label",value:r.label,onChange:u=>S(a,u)})]}),e.jsx(R,{onClick:()=>M(a),className:"btn-warning",children:e.jsx(m,{id:"remove",defaultMessage:"Remove"})})]},a))}),p.sensor_data_labels&&e.jsx(q,{variant:"danger",children:JSON.stringify(p.sensor_data_labels)})]}),e.jsx(C.Text,{className:"invalid-feedback d-block mb-3",children:p.detail}),e.jsx(R,{className:"mt-3",type:"submit",disabled:c.post,children:e.jsx(m,{id:"submit"})})]})};function Pe({label:d,lastItem:t}){return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"card-title",children:d.label}),e.jsx("p",{className:"card-text",children:t&&t.value})]})})}function Fe(){const d="0123456789ABCDEF";let t="#";for(let l=0;l<6;l++)t+=d[Math.floor(Math.random()*16)];return t}const Ie={responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:"Data"}}};_e.register(ge,Ne,Se,we,De,ye,Ce);function Le({device:d,activated:t,lastSensorDataSubmitItem:l,sensorDataSubmitList:o}){const[x,p]=j.useState([]),[g,c]=j.useState([]),[b,i]=j.useState(!1),S=j.useMemo(()=>{const w=[],M=x.map(D=>D.created_at);return g.forEach(D=>{const N=[];x.forEach(r=>{const a=r.sensor_data_list.find(u=>u.label_id===D.label_id);a!==void 0?N.push(a.value):N.push(null)}),w.push({label:D.label,data:N,borderColor:Fe(),backgroundColor:"rgba(255, 99, 132, 0.5)"})}),{labels:M,datasets:w}},[x,g]);return oe(()=>{d&&!b&&(c(d.sensor_data_labels.map(w=>({label_id:w.id,label:w.label}))),i(!0))},[d,b]),_.useEffect(()=>{d&&b&&p(o)},[d,b,o]),e.jsx("div",{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsx(ke,{options:Ie,data:S})})})}const Te=()=>{var z;const d=le(),t=ne(),{user:l}=W(s=>s.auth),{projectData:o}=W(s=>s.project),x=de(),[p,g]=j.useState(!1),[c,b]=j.useState(null),[i,S]=j.useState(null),[w,M]=_.useState([]),[D,N]=j.useState(!1),[r,a]=j.useState({detail:!1,post:!1}),u=_.useRef(null),[f,V]=_.useState([]),[K,Q]=_.useState([]),T=async s=>{var h;a(n=>({...n,detail:!0}));try{const n=await k.fetchDetailProjectWorkDevice(s);b(n.data),g(!!((h=n.data)!=null&&h.activated))}catch(n){n instanceof I&&alert("Error:"+n.response.status)}a(n=>({...n,detail:!1}))},X=async(s,h)=>{await t(pe({project_id:o.id,file_id:s.id,values:h})),await t(fe({project_id:o.id,file_id:s.id}))},Y=s=>{if(N(!1),b(s),confirm(d.formatMessage({id:"dashboard.projects_should_update1",defaultMessage:"Should update code?"}))){const h=be(s);X(s.script,h).then(()=>{const n=`/dashboard/projects/${o.id}/edit`;x(n)})}},B=async()=>{a(s=>({...s,detail:!0}));try{const h=(await k.fetchDetailProjectWorkDevice(c.id)).data;b(h),N(!0)}catch(s){s instanceof I&&s.response&&alert(s.response.data)}a(s=>({...s,detail:!1}))},Z=async()=>{a(s=>({...s,post:!0}));try{await k.fetchDeleteProjectWorkDevice(c.id),g(!1),b(null)}catch(s){s instanceof I&&alert("Error:"+s.response.status)}a(s=>({...s,post:!1}))},G=async s=>{await k.fetchUpdateProjectWorkDevice(c.id,{activated:s}),await T(c.id)},U=()=>{N(!1)},ee=()=>{N(!0)};return j.useEffect(()=>{var s;o&&((s=o.device)!=null&&s.id)&&T(o.device.id)},[o]),j.useEffect(()=>{c&&(async()=>{try{const h=await k.fetchGetDeviceStreamData(c.id),n=h.data.results;if(n.length>0){const v=h.data.results[0];S(v)}M(n.reverse())}catch{}})()},[c]),j.useEffect(()=>{var s;if(p){if(((s=u.current)==null?void 0:s.readyState)===1)return;const h=ie.getCurrentAccessToken(),n=new WebSocket(`wss://smedufacelearn.kz/ws/projects/broadcast/${c.id}/user/?token=${h}`);n.onopen=()=>{a(v=>({...v,detail:!1})),n.send(JSON.stringify({type:"new_user_joined",data:{user_full_name:l.username,token:h}}))},n.onmessage=v=>{var O;const y=JSON.parse(v.data),se=y.from,ae=(O=y.data)==null?void 0:O.to;switch(console.log("onmessage",y,se,ae),y.type){case"new_submit":const J=y.data;S(J),M(L=>{const P=[...L];return P.push(J),P});break;case"new_user_joined":V(y.users_connected);break;case"send_command":Q(L=>{const P=[...L];return P.unshift({author:y.from,content:y.data.command}),P});break}},n.onerror=v=>{console.error(v)},n.onclose=v=>{v.code>=4e3&&t(ue({type:"error",data:{code:v.code,message:v.reason}}))},u.current=n}else u.current&&u.current.close();return()=>{u.current&&u.current.close()}},[p]),e.jsx(xe,{children:e.jsxs("div",{className:"h-100",children:[e.jsxs("div",{className:"d-flex flex-column ",children:[e.jsxs("div",{className:"card w-100 mb-2",children:[e.jsx("div",{className:"card-header",children:e.jsx(m,{id:"device",defaultMessage:"Device"})}),e.jsx("div",{className:"card-body",children:c===null?e.jsxs(me,{className:"p-2",onClick:ee,children:[e.jsx(H,{path:he,color:"#ffffff",size:1}),e.jsx(m,{id:"device",defaultMessage:"Device"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex",children:[e.jsx("button",{className:"btn btn-info me-3 ",onClick:B,children:e.jsx(m,{id:"edit",defaultMessage:"Edit"})}),e.jsx("button",{className:"btn btn-danger me-3",onClick:Z,disabled:r.post,children:e.jsx(m,{id:"delete",defaultMessage:"Delete"})}),p===!0?e.jsx("button",{className:"btn btn-success me-3",onClick:()=>G(!1),disabled:r.post,children:e.jsx(m,{id:"activated",defaultMessage:"Activated"})}):e.jsx("button",{className:"btn btn-warning me-3",onClick:()=>G(!0),disabled:r.post,children:e.jsx(m,{id:"not_activated",defaultMessage:"Not activated"})})]}),e.jsx("div",{className:"row mt-2 ",children:e.jsxs("div",{className:"col-8 col-md-5",children:[e.jsxs("p",{children:["DEVICE_ID = ",`${c.id}`]}),e.jsxs("p",{children:["PASSWORD ="," ",e.jsx("span",{onClick:B,children:"*".repeat(((z=c.password)==null?void 0:z.length)||5)})]})]})})]})})]}),c&&e.jsxs("div",{className:"card w-100",children:[e.jsxs("div",{className:"card-header",children:[e.jsx(m,{id:"data",defaultMessage:"Data"})," ",i==null?void 0:i.updated_at]}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[c==null?void 0:c.sensor_data_labels.map(s=>{var h;return e.jsx("div",{className:"col-9 col-md-6 col-lg-4",children:e.jsx(Pe,{label:s,lastItem:((h=i==null?void 0:i.sensor_data_list)==null?void 0:h.find(n=>s.id===n.label_id))||null})},s.id)}),e.jsx("div",{})]})})]}),c&&e.jsxs("div",{className:"card w-100",children:[e.jsx("div",{className:"card-header",children:e.jsx(m,{id:"dashboard.results_stats"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"row",children:e.jsx(Le,{device:c,lastSensorDataSubmitItem:i,sensorDataSubmitList:w,activated:p})})})]}),c&&e.jsx(Me,{ws:u.current,messages:K})]}),e.jsxs(F,{show:D,onHide:U,children:[e.jsx(F.Header,{closeButton:!0,children:e.jsx(F.Title,{children:e.jsx(m,{id:"dashboard.projects_cuy223",defaultMessage:"Device Form"})})}),e.jsx(F.Body,{children:e.jsx(Ee,{onSuccess:Y,projectWork:o,device:c})}),e.jsx(F.Footer,{children:e.jsx(R,{variant:"secondary",onClick:U,children:e.jsx(m,{id:"close"})})})]})]})})};export{Te as default};
