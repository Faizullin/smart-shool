import{$ as E,b as G,h as v,j as e,F as h,I as J,m as ie,R as p,aq as U,ar as oe,aa as z,a9 as k,D as L,v as H,A as P,u as de,y as ue,a as me,d as he,k as fe,o as pe,K as je,ah as xe,M as S,an as be,am as ve}from"./index-936a227f.js";import{S as O,P as _e,G as ge}from"./ProjectLayout-634b062f.js";import{C as ye}from"./ChatMessageItemCard-b969f056.js";import{C as Se,a as Ne,L as De,P as Ce,b as we,p as ke,c as Me,d as Ee,e as Ae}from"./index-c516e457.js";class M{static async fetchCreateProjectWorkDevice(a){return E.post("/projects/device/",a)}static async fetchUpdateProjectWorkDevice(a,i){return E.patch(`/projects/device/${a}/`,i)}static async fetchDeleteProjectWorkDevice(a){return E.delete(`/projects/device/${a}/`)}static async fetchDetailProjectWorkDevice(a){return E.get(`/projects/device/${a}/`)}static async fetchGetDeviceStreamData(a,i){return E.get(`/projects/device/${a}/stream/`,{params:i})}static async fetchGetDeviceStreamDataLast(a,i){return E.get(`/projects/device/${a}/stream/`,{params:{...i,page_size:1}})}static async fetchGenerateApiKey(a){return E.post(`/projects/device/${a}/generate-key/`)}}const Fe=({ws:l,messages:a})=>{const{user:i}=G(d=>d.auth);v.useState({post:!1});const[o,x]=v.useState(!1),[j,g]=v.useState("");v.useState({});const c=d=>{g(d.target.value)},b=d=>{d.preventDefault(),l.send(JSON.stringify({type:"send_command",data:{command:j,to:"device"}})),g("")};return v.useEffect(()=>{l&&l.readyState===1?x(!0):x(!1)},[l==null?void 0:l.readyState]),e.jsxs("div",{className:"card w-100",children:[e.jsx("div",{className:"card-header",children:e.jsx(h,{id:"send",defaultMessage:"Send"})}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsx("div",{children:e.jsx("form",{className:"form-group px-3",onSubmit:b,children:e.jsxs("div",{className:"input-group mb-3",children:[e.jsx("input",{type:"text",name:"command",value:j,className:"form-control",autoComplete:"off",onChange:c,disabled:!o}),e.jsx("div",{className:"input-group-append",children:e.jsx("button",{type:"submit",className:"btn btn-send-message",children:e.jsx(J,{path:ie,size:1})})})]})})}),e.jsx("div",{className:"px-1",children:a.map((d,N)=>e.jsx(ye,{active_me:i.id===d.author.user_id,message:d},N))})]})})]})},Pe=({onSuccess:l,projectWork:a,device:i})=>{const[o,x]=v.useState({script_id:0,title:"",sensor_data_labels:[{field:"temp",label:"Tempreature"}]}),[j,g]=p.useState({}),[c,b]=p.useState({detail:!1,post:!1}),d=r=>{x(t=>({...t,[r.target.name]:r.target.value}))},N=(r,t)=>{const u=[...o.sensor_data_labels];u[r][t.target.name]=t.target.value,x(f=>({...f,sensor_data_labels:u}))},D=()=>{x(r=>({...r,sensor_data_labels:[...r.sensor_data_labels,{field:"",label:""}]}))},A=r=>{const t=[...o.sensor_data_labels];t.splice(r,1),x(u=>({...u,sensor_data_labels:t}))},C=r=>{r.preventDefault();const t={title:o.title,script_id:o.script_id,sensor_data_labels:o.sensor_data_labels,practical_work_id:a.id};(async()=>{b(f=>({...f,post:!0}));try{if(i){const f=await M.fetchUpdateProjectWorkDevice(i.id,t);l(f.data)}else{const f=await M.fetchCreateProjectWorkDevice(t);l(f.data)}}catch(f){f instanceof P&&f.response?f.response.status==400&&g(f.response.data):console.error(f)}b(f=>({...f,post:!1}))})()},y=p.useMemo(()=>a.files.filter(r=>r.extension===".cpp"),[a.files]);return p.useEffect(()=>{i&&x(r=>({...r,script_id:i.script.id,title:i.title,sensor_data_labels:i.sensor_data_labels}))},[i]),e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{className:"row mb-2",children:[e.jsxs("div",{className:"col-6 form-group mb-2",children:[e.jsx(U,{htmlFor:"title",value:"Title"}),e.jsx(oe,{id:"title",type:"text",name:"title",value:o.title,className:"form-control",autoComplete:"off",isFocused:!0,onChange:d}),e.jsx(z,{message:j.title,className:"mt-2"})]}),e.jsxs("div",{className:"col-6 form-group mb-2",children:[e.jsx(U,{htmlFor:"password",value:e.jsx(h,{id:"script",defaultMessage:"Script"})}),e.jsxs(k.Select,{name:"script_id",value:o.script_id,onChange:d,children:[e.jsx("option",{value:0,children:"---"}),y.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),e.jsx(z,{message:j.script_id,className:"mt-2"})]})]}),i?e.jsx(H,{variant:"warning",children:e.jsx(h,{id:"dashboard.projects_waruu2",defaultMessage:"To modify labels you should recreate new device"})}):e.jsxs("div",{children:[e.jsx(O,{className:"btn-success mb-3",onClick:D,children:e.jsx(h,{id:"dashboard.projects_ad28992",defaultMessage:"Add Variable"})}),e.jsx("div",{className:"row mb-4",children:o.sensor_data_labels.map((r,t)=>e.jsxs("div",{className:"col-6",children:[e.jsxs(k.Group,{className:"mb-3",children:[e.jsx(k.Label,{htmlFor:`input-${t}-field`,children:e.jsx(h,{id:"dashboard.projects_ui328992",defaultMessage:"Field name"})}),e.jsx(k.Control,{id:`input-${t}-field`,name:"field",value:r.field,onChange:u=>N(t,u)})]}),e.jsxs(k.Group,{className:"mb-3",children:[e.jsx(k.Label,{htmlFor:`input-${t}-label`,children:e.jsx(h,{id:"label",defaultMessage:"Label"})}),e.jsx(k.Control,{id:`input-${t}-label`,name:"label",value:r.label,onChange:u=>N(t,u)})]}),e.jsx(L,{onClick:()=>A(t),className:"btn-warning",children:e.jsx(h,{id:"remove",defaultMessage:"Remove"})})]},t))}),j.sensor_data_labels&&e.jsx(H,{variant:"danger",children:JSON.stringify(j.sensor_data_labels)})]}),e.jsx(k.Text,{className:"invalid-feedback d-block mb-3",children:j.detail}),e.jsx(L,{className:"mt-3",type:"submit",disabled:c.post,children:e.jsx(h,{id:"submit"})})]})};function Le({label:l,lastItem:a}){return e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h5",{className:"card-title",children:l.label}),e.jsx("p",{className:"card-text",children:a&&a.value})]})})}function $e(){const l="0123456789ABCDEF";let a="#";for(let i=0;i<6;i++)a+=l[Math.floor(Math.random()*16)];return a}const Ie={responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:"Data"}}};Se.register(Ne,De,Ce,we,ke,Me,Ee);function Ge({device:l,activated:a,lastSensorDataSubmitItem:i,sensorDataSubmitList:o}){const[x,j]=p.useState([]),[g,c]=p.useState([]),[b,d]=p.useState(!1),N=p.useMemo(()=>{const D=[],A=x.map(C=>C.created_at);return g.forEach(C=>{const y=[];x.forEach(r=>{const t=r.sensor_data_list.find(u=>u.label_id===C.label_id);t!==void 0?y.push(t.value):y.push(null)}),D.push({label:C.label,data:y,borderColor:$e(),backgroundColor:"rgba(255, 99, 132, 0.5)"})}),{labels:A,datasets:D}},[x,g]);return de(()=>{l&&!b&&(c(l.sensor_data_labels.map(D=>({label_id:D.id,label:D.label}))),d(!0))},[l,b]),v.useEffect(()=>{l&&b&&j(o)},[l,b,o]),e.jsx("div",{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsx(Ae,{options:Ie,data:N})})})}const Ke=()=>{const l=ue(),a=me(),{user:i}=G(s=>s.auth),{projectData:o}=G(s=>s.project),x=he(),[j,g]=p.useState(!1),[c,b]=p.useState(null),[d,N]=p.useState(null),[D,A]=v.useState([]),[C,y]=p.useState(!1),[r,t]=p.useState({detail:!1,post:!1}),u=v.useRef(null),[f,q]=v.useState([]),[V,Q]=v.useState([]),[X,Y]=v.useState(null),[Z,$]=v.useState(!1),W=async s=>{var m;t(n=>({...n,detail:!0}));try{const n=await M.fetchDetailProjectWorkDevice(s);b(n.data),g(!!((m=n.data)!=null&&m.activated))}catch(n){n instanceof P&&alert("Error:"+n.response.status)}t(n=>({...n,detail:!1}))},ee=async(s,m)=>{await a(be({project_id:o.id,file_id:s.id,values:m})),await a(ve({project_id:o.id,file_id:s.id}))},se=s=>{if(y(!1),b(s),confirm(l.formatMessage({id:"dashboard.projects_should_update1",defaultMessage:"Should update code?"}))){const m=ge(s);ee(s.script,m).then(()=>{const n=`/dashboard/projects/${o.id}/edit`;x(n)})}},ae=async()=>{t(s=>({...s,detail:!0}));try{const m=(await M.fetchDetailProjectWorkDevice(c.id)).data;b(m),y(!0)}catch(s){s instanceof P&&s.response&&alert(s.response.data)}t(s=>({...s,detail:!1}))},te=async()=>{t(s=>({...s,post:!0}));try{await M.fetchDeleteProjectWorkDevice(c.id),g(!1),b(null)}catch(s){s instanceof P&&alert("Error:"+s.response.status)}t(s=>({...s,post:!1}))},R=async s=>{await M.fetchUpdateProjectWorkDevice(c.id,{activated:s}),await W(c.id)},T=()=>{y(!1)},re=()=>{y(!0)},ce=v.useCallback(()=>{c&&confirm("Generate new api key?")&&M.fetchGenerateApiKey(c.id).then(s=>{if(s.data){const m=s.data.key;Y(m),$(!0)}})},[c]);return p.useEffect(()=>{var s;o&&((s=o.device)!=null&&s.id)&&W(o.device.id)},[o]),p.useEffect(()=>{c&&(async()=>{try{const m=await M.fetchGetDeviceStreamData(c.id),n=m.data.results;if(n.length>0){const _=m.data.results[0];N(_)}A(n.reverse())}catch{}})()},[c]),p.useEffect(()=>{var s;if(j){if(((s=u.current)==null?void 0:s.readyState)===1)return;const m=fe.getCurrentAccessToken(),n=new WebSocket(`wss://smedufacelearn.kz/ws/projects/broadcast/${c.id}/user/?token=${m}`);n.onopen=()=>{t(_=>({..._,detail:!1})),n.send(JSON.stringify({type:"new_user_joined",data:{user_full_name:i.username,token:m}}))},n.onmessage=_=>{var B;const w=JSON.parse(_.data),ne=w.from,le=(B=w.data)==null?void 0:B.to;switch(console.log("onmessage",w,ne,le),w.type){case"new_submit":const K=w.data;N(K),A(I=>{const F=[...I];return F.push(K),F});break;case"new_user_joined":q(w.users_connected);break;case"send_command":Q(I=>{const F=[...I];return F.unshift({author:w.from,content:w.data.command}),F});break}},n.onerror=_=>{console.error(_)},n.onclose=_=>{_.code>=4e3&&a(pe({type:"error",data:{code:_.code,message:_.reason}}))},u.current=n}else u.current&&u.current.close();return()=>{u.current&&u.current.close()}},[j]),e.jsx(_e,{children:e.jsxs("div",{className:"h-100",children:[e.jsxs("div",{className:"d-flex flex-column ",children:[e.jsxs("div",{className:"card w-100 mb-2",children:[e.jsx("div",{className:"card-header",children:e.jsx(h,{id:"device",defaultMessage:"Device"})}),e.jsx("div",{className:"card-body",children:r.detail?e.jsx("div",{children:"loading..."}):e.jsx(e.Fragment,{children:c===null?e.jsxs(je,{className:"p-2",onClick:re,children:[e.jsx(J,{path:xe,color:"#ffffff",size:1}),e.jsx(h,{id:"device",defaultMessage:"Device"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"d-flex",children:[e.jsx("button",{className:"btn btn-info me-3 ",onClick:ae,children:e.jsx(h,{id:"edit",defaultMessage:"Edit"})}),e.jsx("button",{className:"btn btn-danger me-3",onClick:te,disabled:r.post,children:e.jsx(h,{id:"delete",defaultMessage:"Delete"})}),j===!0?e.jsx("button",{className:"btn btn-success me-3",onClick:()=>R(!1),disabled:r.post,children:e.jsx(h,{id:"activated",defaultMessage:"Activated"})}):e.jsx("button",{className:"btn btn-warning me-3",onClick:()=>R(!0),disabled:r.post,children:e.jsx(h,{id:"not_activated",defaultMessage:"Not activated"})})]}),e.jsx("div",{className:"row mt-2 ",children:e.jsxs("div",{className:"col-8 col-md-5",children:[e.jsxs("p",{children:["DEVICE_ID = ",`${c.id}`]}),e.jsx(O,{onClick:ce,children:"Generate api key"})]})})]})})})]}),c&&e.jsxs("div",{className:"card w-100",children:[e.jsxs("div",{className:"card-header",children:[e.jsx(h,{id:"data",defaultMessage:"Data"})," ",d==null?void 0:d.updated_at]}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[c==null?void 0:c.sensor_data_labels.map(s=>{var m;return e.jsx("div",{className:"col-9 col-md-6 col-lg-4",children:e.jsx(Le,{label:s,lastItem:((m=d==null?void 0:d.sensor_data_list)==null?void 0:m.find(n=>s.id===n.label_id))||null})},s.id)}),e.jsx("div",{})]})})]}),c&&e.jsxs("div",{className:"card w-100",children:[e.jsx("div",{className:"card-header",children:e.jsx(h,{id:"dashboard.results_stats"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"row",children:e.jsx(Ge,{device:c,lastSensorDataSubmitItem:d,sensorDataSubmitList:D,activated:j})})})]}),c&&e.jsx(Fe,{ws:u.current,messages:V})]}),e.jsxs(S,{show:C,onHide:T,children:[e.jsx(S.Header,{closeButton:!0,children:e.jsx(S.Title,{children:e.jsx(h,{id:"dashboard.projects_cuy223",defaultMessage:"Device Form"})})}),e.jsx(S.Body,{children:e.jsx(Pe,{onSuccess:se,projectWork:o,device:c})}),e.jsx(S.Footer,{children:e.jsx(L,{variant:"secondary",onClick:T,children:e.jsx(h,{id:"close"})})})]}),e.jsxs(S,{show:Z,onHide:()=>$(!1),children:[e.jsx(S.Header,{closeButton:!0,children:e.jsx(S.Title,{children:"Api Key:"})}),e.jsx(S.Body,{children:e.jsxs("p",{children:["Copy:    ",X]})}),e.jsx(S.Footer,{children:e.jsx(L,{variant:"secondary",onClick:()=>$(!1),children:e.jsx(h,{id:"close"})})})]})]})})};export{Ke as default};
